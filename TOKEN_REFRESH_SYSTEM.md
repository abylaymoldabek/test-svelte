# Система автоматического обновления токенов

Реализованная система автоматически обновляет JWT токены, чтобы пользователи не теряли авторизацию при работе с приложением.

## Основные компоненты

### 1. AuthService (`/lib/services/auth.ts`)
- `ensureValidToken()` - проверяет токен и автоматически обновляет при необходимости
- `shouldRefreshToken()` - проверяет, нужно ли обновить токен (если до истечения < 5 минут)
- `refreshToken()` - обновляет токен используя refresh token
- Автоматически обновляет stores после refresh

### 2. Auth Guard (`/lib/utils/auth-guard.ts`)
- Интегрирован с системой автоматического обновления токенов
- `startTokenWatcher()` - проверяет токены каждую минуту
- Асинхронные проверки авторизации
- Автоматическое перенаправление только при невозможности обновить токен

### 3. Token Store (`/lib/stores/token.ts`)
- Слушает изменения в localStorage
- `refreshTokenPayload()` - принудительное обновление payload
- Автоматическая синхронизация с localStorage

### 4. HTTP Client (`/lib/utils/http-client.ts`)
- Автоматически проверяет токен перед каждым запросом
- Обрабатывает 401 ошибки с автоматическим retry после refresh
- Добавляет Authorization заголовки автоматически

## Как это работает

1. **Перед каждым API запросом**: HTTP клиент проверяет, нужно ли обновить токен
2. **Фоновая проверка**: Каждую минуту проверяется состояние токена
3. **Проактивное обновление**: Токен обновляется за 5 минут до истечения
4. **Обработка ошибок**: При 401 ошибке автоматически пытается обновить токен
5. **Синхронизация**: Все stores автоматически синхронизируются при обновлении

## Преимущества

- ✅ Пользователи не теряют авторизацию при работе
- ✅ Токены обновляются проактивно (до истечения)
- ✅ Обработка сетевых ошибок с retry логикой
- ✅ Автоматическая синхронизация всех компонентов
- ✅ Минимальное влияние на производительность

## Настройки

- **Интервал проверки**: 1 минута (в `startTokenWatcher`)
- **Время до обновления**: 5 минут (в `shouldRefreshToken`)
- **Retry логика**: 1 попытка при 401 ошибке

## Использование

Система работает автоматически. Просто используйте:
- `httpClient` для API запросов
- `useAuthGuard()` в компонентах для защиты страниц
- `tokenPayload` store для доступа к данным пользователя

Всё обновление токенов происходит прозрачно для пользователя.
